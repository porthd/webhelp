<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iCalendar Generator</title>
</head>
<body>

<porthd-icalendarevent button-label="Termin speichern" button-style="background: green; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Zwei <strong>minimal definierte</strong> Termine speichern" button-style="background: green; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting</div>
    <div data-id="END">VEVENT</div>
    <div data-id="BEGIN">VEVENT</div>
    <div data-id="UID">87654323@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting 2</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Fehler wegen fehlender UID bei zwei minimal definierten Termine speichern" button-style="background: red; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting</div>
    <div data-id="END">VEVENT</div>
    <div data-id="BEGIN">VEVENT</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting 2</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Fehler wegen Zusatzzeile wischen END und Beginn bei Einlesen von zwei minimal definierten Terminen speichern" button-style="background: red; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting</div>
    <div data-id="END">VEVENT</div>
    <div data-id="UIF">87654325@example.com</div>
    <div data-id="BEGIN">VEVENT</div>
    <div data-id="UID">87654323@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting 2</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Fehlende UID bei Termin speichern" button-style="background: red; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Fehlende DTSTAMP bei Termin speichern" button-style="background: red; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Fehlende DTSTART bei Termin speichern" button-style="background: red; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="SUMMARY">My Meeting</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Fehlende SUMMARY bei Termin speichern" button-style="background: red; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Unerlaubtes Zusatzfeld - Fehler Termin speichern" button-style="background: red; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="bad-or-good">Error</div>
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="SUMMARY">My Meeting</div>
    <div data-id="CALSCALE">GREGORIAN</div>
    <div data-id="METHOD">PUBLISH</div>
    <div data-id="X-WR-CALNAME">Beispiel-Kalender</div>
    <div data-id="X-WR-TIMEZONE">Europe/Berlin</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Fehlende benötigte Felder - Fehler beim Termin speichern" button-style="background: red; color: white; padding: 15px; border-radius: 8px;"
                 file-name="meeting">
    <div data-id="METHOD">PUBLISH</div>
    <div data-id="X-WR-CALNAME">Beispiel-Kalender</div>
    <div data-id="X-WR-TIMEZONE">Europe/Berlin</div>
</porthd-icalendarevent><br />

<porthd-icalendarevent button-label="Volldefinierten Termin speichern" button-style="background: green; color: white; padding: 15px; border-radius: 8px;"
                 file-name="fullmeeting" prodid="-//Example Corp//NONSGML Event//EN">
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="DTEND">20240401T100000Z</div>
    <div data-id="SUMMARY">Wichtiges Meeting</div>
    <div data-id="DESCRIPTION">Dies ist ein wichtiges Meeting mit allen Beteiligten.</div>
    <div data-id="LOCATION">Konferenzraum 1, Firmengebäude</div>
    <div data-id="GEO">52.520008;13.404954</div>
    <div data-id="PRIORITY">1</div>
    <div data-id="STATUS">CONFIRMED</div>
    <div data-id="CLASS">PUBLIC</div>
    <div data-id="CATEGORIES">Meeting, Arbeit</div>
    <div data-id="ATTENDEE" data-cn="Max Mustermann" data-rsvp="TRUE">mailto:max.mustermann@example.com</div>
    <div data-id="ORGANIZER" data-cn="Chef">mailto:chef@example.com</div>
    <div data-id="URL">https://www.example.com/meeting-info</div>
    <div data-id="ATTACH" data-fmttype="application/pdf">https://www.example.com/agenda.pdf</div>
    <div data-id="SEQUENCE">2</div>
    <div data-id="TRANSP">OPAQUE</div>
    <div data-id="RECURRENCE-ID">20240401T090000Z</div>
    <div data-id="RRULE">FREQ=WEEKLY;COUNT=10</div>
    <div data-id="EXDATE">20240408T090000Z</div>
    <div data-id="CREATED">20240301T100000Z</div>
    <div data-id="LAST-MODIFIED">20240329T110000Z</div>
</porthd-icalendarevent><br />
<porthd-icalendarevent button-label="Zwei voll definierte Termine speichern" button-style="background: green; color: white; padding: 15px; border-radius: 8px;"
                 file-name="fullmeeting" prodid="-//Example Corp//NONSGML Event//EN">
    <div data-id="UID">87654321@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="DTEND">20240401T100000Z</div>
    <div data-id="SUMMARY">Wichtiges Meeting</div>
    <div data-id="DESCRIPTION">Dies ist ein wichtiges Meeting mit allen Beteiligten.</div>
    <div data-id="LOCATION">Konferenzraum 1, Firmengebäude</div>
    <div data-id="GEO">52.520008;13.404954</div>
    <div data-id="PRIORITY">1</div>
    <div data-id="STATUS">CONFIRMED</div>
    <div data-id="CLASS">PUBLIC</div>
    <div data-id="CATEGORIES">Meeting, Arbeit</div>
    <div data-id="ATTENDEE" data-cn="Max Mustermann" data-rsvp="TRUE">mailto:max.mustermann@example.com</div>
    <div data-id="ORGANIZER" data-cn="Chef">mailto:chef@example.com</div>
    <div data-id="URL">https://www.example.com/meeting-info</div>
    <div data-id="ATTACH" data-fmttype="application/pdf">https://www.example.com/agenda.pdf</div>
    <div data-id="SEQUENCE">2</div>
    <div data-id="TRANSP">OPAQUE</div>
    <div data-id="RRULE">FREQ=WEEKLY;COUNT=10</div>
    <div data-id="EXDATE">20240408T090000Z</div>
    <div data-id="CREATED">20240301T100000Z</div>
    <div data-id="LAST-MODIFIED">20240329T110000Z</div>

    <div data-id="END">VEVENT</div>
    <div data-id="BEGIN">VEVENT</div>

    <div data-id="UID">87654326@example.com</div>
    <div data-id="DTSTAMP">20240329T120000Z</div>
    <div data-id="DTSTART">20240401T090000Z</div>
    <div data-id="DTEND">20240401T100000Z</div>
    <div data-id="SUMMARY">Wichtiges Meeting 2</div>
    <div data-id="DESCRIPTION">Dies ist ein wichtiges Meeting mit allen Beteiligten.</div>
    <div data-id="LOCATION">Konferenzraum 1, Firmengebäude</div>
    <div data-id="GEO">52.520008;13.404954</div>
    <div data-id="PRIORITY">1</div>
    <div data-id="STATUS">CONFIRMED</div>
    <div data-id="CLASS">PUBLIC</div>
    <div data-id="CATEGORIES">Meeting, Arbeit</div>
    <div data-id="ATTENDEE" data-cn="Max Mustermann" data-rsvp="TRUE">mailto:max.mustermann@example.com</div>
    <div data-id="ORGANIZER" data-cn="Chef">mailto:chef@example.com</div>
    <div data-id="URL">https://www.example.com/meeting-info</div>
    <div data-id="ATTACH" data-fmttype="application/pdf">https://www.example.com/agenda.pdf</div>
    <div data-id="SEQUENCE">2</div>
    <div data-id="TRANSP">OPAQUE</div>
    <div data-id="RRULE">FREQ=WEEKLY;COUNT=10</div>
    <div data-id="EXDATE">20240408T090000Z</div>
    <div data-id="CREATED">20240301T100000Z</div>
    <div data-id="LAST-MODIFIED">20240329T110000Z</div>
</porthd-icalendarevent><br />

<script>
    class PorthDICalendarEventGenerator extends HTMLElement {
        constructor() {
            super();
            this.attachShadow({ mode: "open" });

            this.button = document.createElement("button");
            this.updateButton();
            this.button.addEventListener("click", () => this.downloadICalendar());

            this.shadowRoot.appendChild(this.button);
        }

        connectedCallback() {
            this.updateButton();
        }

        static get observedAttributes() {
            return ["button-label", "button-style", "file-name", "prodid"];
        }

        attributeChangedCallback() {
            this.updateButton();
        }

        updateButton() {
            this.button.innerHTML = this.getAttribute("button-label") || "download iCal";
            this.button.setAttribute("style", this.getAttribute("button-style") ||
                "background: green; color: white; padding: 10px 15px; border-radius: 5px; border: none; cursor: pointer;");
        }

        downloadICalendar() {
            const validAttributes = {
                "BEGIN": "VEVENT - define a neu event in the file. Not needed for onyl one event",
                "END": "VEVENT - define a neu event in the file. Not needed for onyl one event",

                "UID": "Unique Identification Number of the Event (required)",
                "DTSTAMP": "Creation Timestamp (required)",
                "DTSTART": "Event Start Time (required)",

                "CALSCALE": "Calendar Scale (e.g., GREGORIAN)",
                "METHOD": "Method for the Calendar (e.g., PUBLISH)",
                "X-WR-CALNAME": "Calendar Display Name",
                "X-WR-TIMEZONE": "Calendar Time Zone",
                "DTEND": "Event End Time",
                "SUMMARY": "Brief Description of the Event",
                "DESCRIPTION": "Longer Description of the Event",
                "LOCATION": "Event Location",
                "GEO": "Geographical Coordinates (Latitude; Longitude)",
                "PRIORITY": "Priority (1-9, 1 = highest)",
                "STATUS": "Status (e.g., CONFIRMED, CANCELLED)",
                "CLASS": "Visibility (PUBLIC, PRIVATE, CONFIDENTIAL)",
                "CATEGORIES": "Event categories",
                "ATTENDEE": "Event attendees",
                "ORGANIZER": "Organizer",
                "URL": "Web link to the event",
                "ATTACH": "Attachments (e.g., PDF agenda)",
                "SEQUENCE": "Change count for the event",
                "TRANSP": "Transparency (OPAQUE = busy, TRANSPARENT = free)",
                "RECURRENCE-ID": "Reference to a recurring event",
                "RRULE": "Rule for recurring events",
                "EXDATE": "Exceptions for recurrences",
                "CREATED": "Creation time",
                "LAST-MODIFIED": "Last modified time"
            };

            let icalData = "BEGIN:VCALENDAR\nVERSION:2.0\n";
            let errors = [];
            let prodid = this.getAttribute("prodid") || '--//Porth Dieter//porthd/webhelp webhelp-TYPO3-Extension//DE'; // PRODID wird aus dem Attribut gelesen

            // PRODID in die iCalendar-Daten einfügen, falls gesetzt
            if (prodid) {
                icalData += `PRODID:${prodid}\n`;
            } else {
                icalData += `PRODID:-//PorthDieter porthd//webhelp porthd-icalendarevent//DE\n`;
            }
            // Beginne das Event
            icalData += "BEGIN:VEVENT\n";
            let undefinedRowFlag = false;
            let uidFlag = 0;
            let flagError = true;
            this.querySelectorAll("[data-id]").forEach(element => {
                flagError = false;
                let dataId = element.getAttribute("data-id").toUpperCase();

                if (!validAttributes.hasOwnProperty(dataId)) {
                    errors.push(`❌ undefined data-id: ${dataId} (failed validation of allowed fields in iCalendar-events)`);
                    flagError = true;
                }

                let value = element.textContent.trim();
                let params = "";

                Array.from(element.attributes).forEach(attr => {
                    if (attr.name.startsWith("data-") && attr.name !== "data-id") {
                        let paramName = attr.name.replace("data-", "").toUpperCase();
                        params += `;${paramName}=${attr.value}`;
                    }
                });

                //  // Beginne das Event
                // if (dataId === "UID") {
                //     icalData += "BEGIN:VEVENT\n";
                // }
                if (dataId === "BEGIN") {
                    params = "";
                    value = "VEVENT";
                    uidFlag = 0;
                    undefinedRowFlag = false;
                } else{
                    if (undefinedRowFlag) {
                        errors.push(`❌ missing beginning of next event in the list after definition-end of the former event.`);
                        flagError = true;
                    }
                }
                if (dataId === "END") {
                    params = "";
                    value = "VEVENT";
                    undefinedRowFlag = true;
                    if (uidFlag !== 15) {
                        errors.push(`❌ missing the required field UID (+1), DTSTAMP(+2), DTSTART(+4) or SUMMARY(+8) for the definition of one event. `);
                        flagError = true;
                    }
                }
                if (dataId === "UID") {
                    uidFlag = uidFlag | 1;  // add bit on position 1 in an integer
                }
                if (dataId === "DTSTAMP") {
                    uidFlag = uidFlag | 2; // add bit on position 2 in an integer
                }
                if (dataId === "DTSTART") {
                    uidFlag = uidFlag | 4; // add bit on position 4 in an integer
                }
                if (dataId === "SUMMARY") {
                    uidFlag = uidFlag | 8; // add bit on position 8 in an integer
                }

                if(! flagError ) {
                    icalData += `${dataId}${params}:${value}\n`;
                }

                // Ende das Event
//                if (dataId === "LAST-MODIFIED") {
                //                  icalData += "END:VEVENT\n";
                //            }
            });
            icalData += "END:VEVENT\n";

            icalData += "END:VCALENDAR\n";  // iCalendar-Ende
            if (uidFlag !== 15) {
                errors.push(`❌ missing the required field UID (+1), DTSTAMP(+2), DTSTART(+4) or SUMMARY(+8) for the definition of one event. Found sum: ${uidFlag}.`);
            }

            if(errors.length > 0){
                alert("One or more errors detected:\n\n" + errors.join("\n") + "\n\nGenerated Calendar-Code:\n\n" + icalData);
                return;
            }

            let fileName = this.getAttribute("file-name") || "calendar.ics";
            if (!fileName.toLowerCase().endsWith(".ics")) {
                fileName += ".ics";
            }

            const blob = new Blob([icalData], { type: "text/calendar" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    }

    customElements.define("porthd-icalendarevent", PorthDICalendarEventGenerator);
</script>

</body>
</html>
