<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liste von Lebewesen</title>
    <style>
        .hidden {
            display: none;
        }

        porthd-listselect label {
            font-weight: bold;
        }

        porthd-listselect ul strong {
            font-weight: lighter;
        }

        porthd-listselect label {
            font-style:italic;
        }
        porthd-listselect input {
            color:blue;
        }
    </style>
</head>
<body>
<h1>Funktioniert nicht: Liste von Tieren, Einzellern und Pflanzen</h1>
<div id="doof">
    <label>Hallo Fett</label>
</div>
<porthd-listselect id="porthd-listselect" level="2" filter="" list-tags="li,div" search-length="2"
                   label-range="Tiefe" label-search="Suche" label-reset="zurücksetzen" placeholder="Suchphrase eingeben"
                   label-style="font-style:italic;" input-style="color:blue;" button-style="background:#ffe; color: blue;"
                   range-style="border:red solid 3px;"
                   trim="\(\{\[\]\}\)\*\+\-\.\,"
>
    <div>
        hier kommt auch ein div
    </div>
    <ul>
        <li>Domäne: Archaeen
            <ul>
                <li>Reich: Tiere
                    <ul>
                        <li>Stamm: Chordatiere
                            <ul>
                                <li>Klasse: Säugetiere
                                    <ul>
                                        <li><strong>Ordnung: Carnivora (Raubtiere)</strong>
                                            <ul>
                                                <li><strong>Familie: Felidae (Katzenartige)</strong>
                                                    <ul>
                                                        <li><strong>Gattung: Panthera</strong>
                                                            <ul>
                                                                <li>Art: Panthera leo (Löwe)</li>
                                                                <li>Art: Panthera tigris (Tiger)</li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </li>
                                        <li>Ordnung: Proboscidea
                                            <ul>
                                                <li>Familie: Elephantidae
                                                    <ul>
                                                        <li>Gattung: Loxodonta
                                                            <ul>
                                                                <li>Art: Loxodonta africana (Afrikanischer Elefant)</li>
                                                                <li>Art: Loxodonta cyclotis (Waldelefant)</li>
                                                            </ul>
                                                        </li>
                                                        <li>Gattung: Elephas
                                                            <ul>
                                                                <li>Art: Elephas maximus (Asiatischer Elefant)</li>
                                                            </ul>
                                                        </li>
                                                        <li>Gattung: Mammuthus (ausgestorben)
                                                            <ul>
                                                                <li>Art: Mammuthus primigenius (Wollhaarmammut)</li>
                                                                <li>Art: Mammuthus columbi (Kolumbianisches Mammut)</li>
                                                                <li>Art: Mammuthus meridionalis (Südelefant)</li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </li>

                                        <li>Ordnung: Cetacea
                                            <ul>
                                                <li>Familie: Delphinidae (Delfine)
                                                    <ul>
                                                        <li>Gattung: Delphinus
                                                            <ul>
                                                                <li>Art: Delphinus delphis (Gemeiner Delfin)</li>
                                                                <li>Art: Delphinus capensis (Langschnauzendelfin)</li>
                                                            </ul>
                                                        </li>
                                                        <li>Gattung: Tursiops
                                                            <ul>
                                                                <li>Art: Tursiops truncatus (Großer Tümmler)</li>
                                                                <li>Art: Tursiops aduncus (Indopazifischer Großer Tümmler)
                                                                </li>
                                                            </ul>
                                                        </li>
                                                        <li>Gattung: Stenella
                                                            <ul>
                                                                <li>Art: Stenella attenuata (Gefleckter Delfin)</li>
                                                                <li>Art: Stenella longirostris (Spinner-Delfin)</li>
                                                                <li>Art: Stenella coeruleoalba (Streifendelfin)</li>
                                                            </ul>
                                                        </li>
                                                        <li>Gattung: Orcinus
                                                            <ul>
                                                                <li>Art: Orcinus orca (Schwertwal / Orca)</li>
                                                            </ul>
                                                        </li>
                                                        <li>Gattung: Lagenodelphis
                                                            <ul>
                                                                <li>Art: Lagenodelphis hosei (Schlankdelfin)</li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                                <li>Familie: Phocoenidae (Schweinswale)
                                                    <ul>
                                                        <li>Gattung: Phocoena
                                                            <ul>
                                                                <li>Art: Phocoena phocoena (Gewöhnlicher Schweinswal)</li>
                                                                <li>Art: Phocoena sinus (Vaquita / Kalifornischer
                                                                    Schweinswal)
                                                                </li>
                                                                <li>Art: Phocoena dioptrica (Brillenschweinswal)</li>
                                                            </ul>
                                                        </li>
                                                        <li>Gattung: Neophocaena
                                                            <ul>
                                                                <li>Art: Neophocaena phocaenoides (Finless-Schweinswal)</li>
                                                            </ul>
                                                        </li>
                                                        <li>Gattung: Australophocaena
                                                            <ul>
                                                                <li>Art: Australophocaena dioptrica (Südlicher Schweinswal)
                                                                </li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </li>

                                    </ul>
                                </li>
                                <li>Klasse: Vögel
                                    <ul>
                                        <li>Art: Adler (*Aquila chrysaetos*)</li>
                                        <li>Art: Pinguin (*Aptenodytes forsteri*)</li>
                                        <li>Art: Papagei (*Ara ararauna*)</li>
                                    </ul>
                                </li>
                                <li>Klasse: Reptilien
                                    <ul>
                                        <li>Art: Krokodil (*Crocodylus niloticus*)</li>
                                        <li>Art: Leguan (*Iguana iguana*)</li>
                                        <li>Art: Schlange (*Naja naja*)</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>Stamm: Gliederfüßer
                            <ul>
                                <li>Klasse: Insekten
                                    <ul>
                                        <li>Art: Ameise (*Formica rufa*)</li>
                                        <li>Art: Schmetterling (*Papilio machaon*)</li>
                                        <li><strong>Ordnung: Coleoptera (Käfer)</strong>
                                            <ul>
                                                <li><strong>Familie: Coccinellidae (Marienkäfer)</strong>
                                                    <ul>
                                                        <li><strong>Gattung: Coccinella</strong>
                                                            <ul>
                                                                <li>Art: Coccinella septempunctata
                                                                    (Siebenpunkt-Marienkäfer)
                                                                </li>
                                                            </ul>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        </li>
                                    </ul>
                                </li>
                                <li>Klasse: Spinnentiere
                                    <ul>
                                        <li>Art: Tarantel (*Theraphosa blondi*)</li>
                                        <li>Art: Skorpion (*Androctonus australis*)</li>
                                        <li>Art: Zecke (*Ixodes ricinus*)</li>
                                    </ul>
                                </li>
                                <li>Klasse: Krebstiere
                                    <ul>
                                        <li>Art: Hummer (*Homarus gammarus*)</li>
                                        <li>Art: Krabbe (*Carcinus maenas*)</li>
                                        <li>Art: Garnelen (*Palaemon serratus*)</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
                <li>Reich: Pflanzen
                    <div>Stamm: Bedecktsamer
                        <ul>
                            <li>Klasse: Einkeimblättrige
                                <ul>
                                    <li>Art: Reis (*Oryza sativa*)</li>
                                    <li>Art: Banane (*Musa acuminata*)</li>
                                    <li>Art: Tulpe (*Tulipa gesneriana*)</li>
                                </ul>
                            </li>
                            <li>Klasse: Zweikeimblättrige
                                <ul>
                                    <li>Art: Rose (*Rosa canina*)</li>
                                    <li>Art: Eiche (*Quercus robur*)</li>
                                    <li>Art: Sonnenblume (*Helianthus annuus*)</li>
                                </ul>
                            </li>
                            <li>Klasse: Magnoliopsida
                                <ul>
                                    <li>Art: Magnolie (*Magnolia grandiflora*)</li>
                                    <li>Art: Ahorn (*Acer pseudoplatanus*)</li>
                                    <li>Art: Klee (*Trifolium pratense*)</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div>Stamm: Farne
                        <ul>
                            <li>Klasse: Echter Farn
                                <ul>
                                    <li>Art: Adlerfarn (*Pteridium aquilinum*)</li>
                                    <li>Art: Königsfarn (*Osmunda regalis*)</li>
                                    <li>Art: Streifenfarn (*Asplenium trichomanes*)</li>
                                </ul>
                            </li>
                            <li>Klasse: Moosfarne
                                <ul>
                                    <li>Art: Selaginelle (*Selaginella lepidophylla*)</li>
                                    <li>Art: Quellmoos (*Fontinalis antipyretica*)</li>
                                    <li>Art: Hornmoos (*Anthoceros agrestis*)</li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                </li>
                <li>Reich: Pilze
                    <ul>
                        <li>Stamm: Ständerpilze
                            <ul>
                                <li>Klasse: Hutpilze
                                    <ul>
                                        <li>Art: Champignon (*Agaricus bisporus*)</li>
                                        <li>Art: Fliegenpilz (*Amanita muscaria*)</li>
                                        <li>Art: Steinpilz (*Boletus edulis*)</li>
                                    </ul>
                                </li>
                                <li>Klasse: Rostpilze
                                    <ul>
                                        <li>Art: Weizenrost (*Puccinia graminis*)</li>
                                        <li>Art: Birnengitterrost (*Gymnosporangium sabinae*)</li>
                                        <li>Art: Kiefernblasenrost (*Cronartium ribicola*)</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                        <li>Stamm: Schlauchpilze
                            <ul>
                                <li>Klasse: Hefe
                                    <ul>
                                        <li>Art: Bäckerhefe (*Saccharomyces cerevisiae*)</li>
                                        <li>Art: Bierhefe (*Saccharomyces pastorianus*)</li>
                                        <li>Art: Candida (*Candida albicans*)</li>
                                    </ul>
                                </li>
                                <li>Klasse: Trüffelpilze
                                    <ul>
                                        <li>Art: Schwarzer Trüffel (*Tuber melanosporum*)</li>
                                        <li>Art: Weißer Trüffel (*Tuber magnatum*)</li>
                                        <li>Art: Wüstentrüffel (*Terfezia claveryi*)</li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ul>
        </li>
    </ul>
</porthd-listselect>

<script>
    class PorthDListSelectFilter extends HTMLElement {
        constructor() {
            super();
            this.attachShadow({ mode: 'open' });
            let searchLength = parseInt(this.getAttribute('search-length'), 10);
            this.searchLength = (isNaN(searchLength) || searchLength < 2) ? 2 : searchLength;

            this.listTags = this.getAttribute('list-tags') || 'li,dt';
            this.defaultLevel = Math.max(1, (parseInt(this.getAttribute('level'),10) || 1));
            // this.updateMaxDepth();
            this.suggestions = new Set();
            this.shadowRoot.innerHTML = `
            <style>
                label { ${this.getAttribute('label-style') || ''} }
                input[type="search"] { ${this.getAttribute('input-style') || ''} }
                input[type="range"] { ${this.getAttribute('range-style') || ''} }
                button { ${this.getAttribute('button-style') || ''} }
                .hidden { display: none; }
            </style>
            <form>
            <label for="levelRange">${this.getAttribute('label-range') || 'level'} [<span id="levelDisplay"></span>]</label>
            <input id="levelRange" style="background: #0078d7;" type="range" min="1" step="1" value="${this.defaultLevel}" />
            <label for="searchInMenu">${this.getAttribute('label-search') || 'search'}</label>
            <input type="search" id="searchInMenu" value="${this.getAttribute('filter') || ''}" placeholder="${this.getAttribute('placeholder') || 'input search text'}" list="autocompleteList" autocomplete="off"/>
              <button type="reset">${this.getAttribute('label-reset') || 'reset'}</button>
            <datalist id="porthd-listselectfilter-autocompleteList"></datalist>
            <slot></slot>
            </form>
        `;
            this.levelRange = this.shadowRoot.getElementById("levelRange");
            this.levelDisplay = this.shadowRoot.getElementById("levelDisplay");
            this.searchInMenu = this.shadowRoot.getElementById("searchInMenu");
            this.autocompleteList = this.shadowRoot.getElementById("porthd-listselectfilter-autocompleteList");
            let charset = this.getAttribute('trim') || '({[]})*+-.,';
            // escape all chars for use in regexp
            charset = charset.split('').map(char => '\\' + char).join('');
            this.regexp = null;
            if ((charset) && (charset.length >0)){
                this.regexp = new RegExp(`^[${charset}]+|[${charset}]+$`, 'g');
            }

        }

        connectedCallback() {
            this.updateMaxDepth();
            this.extractSuggestions();
            this.levelRange.addEventListener("input", () => this.filterLevels());
            this.searchInMenu.addEventListener("input", () => this.filterLevels());
            this.filterLevels();
        }

        updateMaxDepth() {
            const listItems = this.querySelectorAll(this.listTags);
            let maxDepth = 0;
            listItems.forEach(li => {
                maxDepth = Math.max(maxDepth, this.getDepth(li));
            });
            this.levelRange.max = maxDepth;
            this.levelRange.value = Math.min(this.defaultLevel, maxDepth);
            this.levelDisplay.textContent = this.levelRange.value;
        }
        trimCustomCharacters(testString) {
            // return testString.replace(new RegEx, '');
            if (this.regexp) {
                return testString.replace(this.regexp, '');
            }
            return testString;
        }

        extractSuggestions() {
            const listItems = this.querySelectorAll(this.listTags);
            listItems.forEach(li => {
                li.textContent.toLowerCase().split(/\s+/).forEach(word => {
                    if (word.length > 1) {
                        const newWord = this.trimCustomCharacters(word);
                        if(word.startsWith('(')) {
                            console.log('test', word, newWord)
                        }
                        this.suggestions.add(newWord);
                    }
                });
            });
            console.log('before this.suggestions',this.suggestions);
            this.suggestions = [...new Set(this.suggestions)];
            console.log('after this.suggestions',this.suggestions);
            this.suggestions = this.suggestions.sort();
            this.updateDatalist();
        }

        updateDatalist() {
            this.autocompleteList.innerHTML = '';
            Array.from(this.suggestions).forEach(word => {
                const option = document.createElement("option");
                option.value = word;
                this.autocompleteList.appendChild(option);
            });
        }

        filterLevels() {
            const maxLevel = parseInt(this.levelRange.value);
            this.levelDisplay.textContent = maxLevel;
            const listItems = this.querySelectorAll(this.listTags);
            const searchText = this.searchInMenu.value.toLowerCase();

            listItems.forEach(li => {
                const depth = this.getDepth(li);
                const text = li.textContent.toLowerCase();

                if (searchText.length >= this.searchLength && text.includes(searchText)) {
                    li.classList.remove("hidden");
                } else {
                    const parentList = li.closest(this.listTags);
                    if (parentList) {
                        const parentDepth = this.getDepth(parentList);
                        li.classList.toggle("hidden", parentDepth >= maxLevel);
                    }
                }
            });
        }

        getDepth(element) {
            let depth = 0;
            while (element.parentElement && element.parentElement.closest(this.listTags)) {
                depth++;
                element = element.parentElement.closest(this.listTags);
            }
            return depth;
        }
    }

    customElements.define("porthd-listselect", PorthDListSelectFilter);

</script>
</body>
</html>
